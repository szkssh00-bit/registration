<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>アンケートシステム</title>
  <style>
    :root{ --line:#00b900; --bg:#f6f7f9; --card:#ffffff; --text:#222; --border:#e5e7eb; --radius: 14px; }
    body{ font-family: system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    .wrap{ max-width: 680px; margin: 0 auto; padding: 20px 14px; }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h1{ font-size: 18px; margin: 0 0 15px; border-bottom: 2px solid var(--line); padding-bottom: 8px; }
    .btn{ width: 100%; padding: 15px; border-radius: 10px; border: none; background: var(--line); color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
    .jst-link { display: block; text-align: center; margin-top: 20px; color: #007bff; text-decoration: none; font-weight: bold; }
    select, input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); box-sizing: border-box; }
    label { font-size: 13px; font-weight: bold; display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="mainForm" class="card">
      <h1>卒業生の動向調査</h1>
      <div id="formContent">
        <label>生年</label><select id="by"></select>
        <label>生月</label><select id="bm"></select>
        <label>卒業年</label><select id="gy"></select>
        <label>学科</label><select id="dp"></select>
        <label>性別</label><select id="gender"></select>
        <label>現在の状況</label><select id="status"></select>
        <label>専攻分野</label><select id="major"></select>
        <label>職業</label><select id="job"></select>
        <button id="btn" class="btn">送信して次へ</button>
      </div>
    </div>

    <div id="jstArea" class="card" style="display:none;">
      <h1>JST卒業生調査</h1>
      <p style="font-size:14px; line-height:1.6;">外部サイト（JST）のアンケートページを開きます。回答後、この画面を閉じてください。</p>
      <button id="jstBtn" class="btn">アンケートサイトを開く</button>
      <button id="closeBtn" class="btn" style="background:#666; margin-top:20px;">回答完了して閉じる</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008793146-jMVaCpQM';
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwwFGnUaMDZwTkmCWlYNDmyHErYBkhXf1ROCyLn1jF7nJ_GIMpzrElXQEXZqS3n-Lueow/exec";

    const els = {
      by: document.getElementById("by"), bm: document.getElementById("bm"),
      gy: document.getElementById("gy"), dp: document.getElementById("dp"),
      gender: document.getElementById("gender"), status: document.getElementById("status"),
      major: document.getElementById("major"), job: document.getElementById("job")
    };

    function initUi(){
      const fill = (el, arr) => {
        el.innerHTML = '<option value="">選択してください</option>';
        arr.forEach(v => { const o = document.createElement("option"); o.value=v; o.textContent=v; el.appendChild(o); });
      };
      const range = (s,e) => Array.from({length:e-s+1},(_,i)=>s+i);
      fill(els.by, range(1960, 2025));
      fill(els.bm, range(1, 12));
      fill(els.gy, range(1970, 2030).map(y => y + "年3月"));
      fill(els.dp, ["理数科","国際コミュニケーション学科","普通科"]);
      fill(els.gender, ["男性","女性","回答しない"]);
      fill(els.status, ["大学学部生","大学院生修士課程","大学院生博士課程","短期大学生","専門学校生等","大学校生","進学準備中","高校卒業後に就職","短期大学・専門学校等卒業後に就職","大学・大学校卒業後就職","大学院修了後に就職","その他"]);
      fill(els.major, ["理学系","数学系","工学系","情報系","医歯薬看護系","農学系","教育系(理数系)","その他理系","人文社会科学系","法・政治・経済系","芸術系","その他文系","その他"]);
      fill(els.job, ["公的機関の研究者","企業研究者","技術系公務員","医歯薬看護師","理数系教員","その他理系職種","文系職種","その他"]);
    }

    async function submit() {
      for(let key in els) { if(!els[key].value){ alert("全項目入力してください"); return; } }
      document.getElementById("btn").disabled = true;

      try {
        const profile = await liff.getProfile();
        const params = new URLSearchParams();
        params.set("type", "liff_submit");
        params.set("userId", profile.userId);
        params.set("displayName", profile.displayName);
        for(let key in els) params.set(key, els[key].value);

        await fetch(GAS_URL, { method:"POST", body: params });

        if (liff.isInClient()) {
          await liff.sendMessages([{ type: 'text', text: 'アンケートの回答が完了しました！\nご協力ありがとうございました。' }]);
          liff.closeWindow();
        }
      } catch (e) { alert(e); }
    }

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) { liff.login(); return; }

      const urlParams = new URLSearchParams(window.location.search);
      const targetUrl = urlParams.get('url');

      // JSTアンケートモードの表示切り替え
      if (targetUrl) {
        document.getElementById("mainForm").style.display = "none";
        document.getElementById("jstArea").style.display = "block";
        
        document.getElementById("jstBtn").onclick = () => {
          liff.openWindow({ url: targetUrl, external: true });
        };

        document.getElementById("closeBtn").onclick = async () => {
          if (liff.isInClient()) {
            // 5項：LIFFを閉じる際にメッセージを送り、GAS側のhandleNewsを起動させる
            await liff.sendMessages([{ type: 'text', text: 'JSTアンケート画面を閉じました。' }]);
            liff.closeWindow();
          }
        };
      } else {
        initUi();
        document.getElementById("btn").onclick = submit;
      }
    };
  </script>
</body>
</html>
