<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>調査システム</title>
  <style>
    :root{ --line:#00b900; --bg:#f6f7f9; --card:#ffffff; --text:#222; --border:#e5e7eb; --radius: 14px; }
    body{ font-family: system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    .wrap{ max-width: 680px; margin: 0 auto; padding: 18px 14px; }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h1{ font-size: 18px; margin: 0 0 15px; border-bottom: 2px solid var(--line); padding-bottom: 8px; }
    .btn{ width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--line); color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; }
    select, input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--border); box-sizing: border-box; font-size: 15px; }
    label { font-size: 13px; font-weight: bold; display: block; margin-bottom: 4px; color: #555; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="formSection" class="card">
      <h1>卒業生の動向調査</h1>
      <label>生年</label><select id="by"></select>
      <label>生月</label><select id="bm"></select>
      <label>卒業年</label><select id="gy"></select>
      <label>学科</label><select id="dp"></select>
      <label>性別</label><select id="gender"></select>
      <label>現在の状況</label><select id="status"></select>
      <label>専攻分野</label><select id="major"></select>
      <label>職業</label><select id="job"></select>
      <button id="btn" class="btn">回答を送信し、本校を紹介</button>
    </div>

    <div id="jstSection" class="card" style="display:none;">
      <h1>JST卒業生調査</h1>
      <p style="font-size:14px; line-height:1.6; margin-bottom:20px;">
      【お願い】\n【2026/1/28まで】\n現在、国立研究開発法人 科学技術振興機構(JST)による、SSHの教育カリキュラムを受けた卒業生（2019年度より全校生徒対象、それ以前は理数科対象）の調査を実施しています。\n\n毎年、郵送させていただいておりましたが、今年度からLINEに移行いたします。何卒ご協力を宜しくお願いいたします。\n
       外部サイト（JST）のアンケートページを開きます。回答が完了しましたら、下のボタンを押して終了してください。
      </p>
      <button id="jstBtn" class="btn" style="background:#007bff; margin-bottom:15px;">JST調査サイトを開く</button>
      <button id="closeBtn" class="btn" style="background:#666;">終了して本校のニュースを見る</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008793146-jMVaCpQM';
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxYfZ_8f-tdotSo4vGKjDoVvEkDKR4S3JM9efb18royJkp2GdQzURoQo3Qb5xFFklTIPA/exec";
    const BOT_ID = "@512stcdu";
    const JST_URL = "https://form2.jst.go.jp/s/r7_ssh_ishiki_sotugyou";

    const els = {
      by: document.getElementById("by"), bm: document.getElementById("bm"),
      gy: document.getElementById("gy"), dp: document.getElementById("dp"),
      gender: document.getElementById("gender"), status: document.getElementById("status"),
      major: document.getElementById("major"), job: document.getElementById("job")
    };

    function initUi(){
      const fill = (el, arr) => {
        el.innerHTML = '<option value="">選択</option>';
        arr.forEach(v => { const o = document.createElement("option"); o.value=v; o.textContent=v; el.appendChild(o); });
      };
      const range = (s,e) => Array.from({length:e-s+1},(_,i)=>s+i);
      fill(els.by, range(1960, 2025));
      fill(els.bm, range(1, 12));
      fill(els.gy, range(1970, 2030).map(y => y + "年3月"));
      fill(els.dp, ["理数科","国際コミュニケーション学科","普通科"]);
      fill(els.gender, ["男性","女性","回答しない"]);
      fill(els.status, ["大学学部生","大学院生修士課程","大学院生博士課程","短期大学生","専門学校生等","大学校生","進学準備中","高校卒業後に就職","短期大学・専門学校等卒業後に就職","大学・大学校卒業後就職","大学院修了後に就職","その他"]);
      fill(els.major, ["理学系","数学系","工学系","情報系","医歯薬看護系","農学系","教育系(理数系)","その他理系","人文社会科学系","法・政治・経済系","芸術系","その他文系","その他"]);
      fill(els.job, ["公的機関の研究者","企業研究者","技術系公務員","医歯薬看護師","理数系教員","その他理系職種","文系職種","その他"]);
    }

    async function submit() {
      for(let key in els) { if(!els[key].value){ alert("すべての項目を入力してください"); return; } }
      document.getElementById("btn").disabled = true;

      try {
        const profile = await liff.getProfile();
        const params = new URLSearchParams();
        params.set("type", "liff_submit");
        params.set("userId", profile.userId);
        params.set("displayName", profile.displayName);
        for(let key in els) params.set(key, els[key].value);

        await fetch(GAS_URL, { method:"POST", body: params });

        if (liff.isInClient()) {
          // 4. トーク画面にメッセージ送信
          await liff.sendMessages([{ type: 'text', text: 'アンケートの回答が完了しました！\nご協力ありがとうございました。' }]);
          
          // 4. 紹介（ShareTargetPicker）
          if (liff.isApiAvailable('shareTargetPicker')) {
            await liff.shareTargetPicker([{
              "type": "flex", "altText": "おすすめのLINEボットを紹介します！",
              "contents": {
                "type": "bubble",
                "body": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "静岡北高校SSH", "weight": "bold", "color": "#00b900" }] },
                "footer": { "type": "box", "layout": "vertical", "contents": [{ "type": "button", "style": "primary", "color": "#00b900", "action": { "type": "uri", "label": "友だち追加する", "uri": "https://line.me/R/ti/p/" + BOT_ID } }] }
              }
            }]);
          }
          // 5. 閉じる
          liff.closeWindow();
        }
      } catch (e) { alert("エラー: " + e); }
    }

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) { liff.login(); return; }

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('mode') === 'jst') {
        // 7. JSTアンケートモード
        document.getElementById("formSection").style.display = "none";
        document.getElementById("jstSection").style.display = "block";
        document.getElementById("jstBtn").onclick = () => liff.openWindow({ url: JST_URL, external: true });
        document.getElementById("closeBtn").onclick = async () => {
          if (liff.isInClient()) {
            // 8. 閉じる合図を送信 → これでSZK_Newsが起動
            await liff.sendMessages([{ type: 'text', text: 'JSTアンケート画面を終了しました。' }]);
            liff.closeWindow();
          }
        };
      } else {
        initUi();
        document.getElementById("btn").onclick = submit;
      }
    };
  </script>
</body>
</html>
